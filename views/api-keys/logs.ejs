<!-- Path: /views/api-keys/logs.ejs -->
<%- include('../layouts/main', { 
    title: 'API Logs - ' + apiKey.app_name,
    body: ` 
    <div class="max-w-full mx-auto">
        <!-- Header -->
        <%- include('../partials/page-header', { 
            title: 'API Logs: ' + apiKey.app_name,
            description: 'View detailed API request logs for this key',
            icon: 'list-alt',
            iconColor: 'blue',
            addUrl: '/api-keys/' + apiKey.api_key_id,
            addText: 'Back to Details'
        }) %>

        <!-- Filters Section -->
        <%- include('../partials/logs-filter-card', { 
            action: '/api-keys/' + apiKey.api_key_id + '/logs',
            query: query || {},
            apiKeyId: apiKey.api_key_id,
            csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : null
        }) %>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-4 mb-6">
            <div class="card-elevated">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-secondary truncate">
                        <i class="fas fa-chart-line mr-1" aria-hidden="true"></i>
                        Total Requests
                    </dt>
                    <dd class="mt-1 text-3xl font-semibold text-primary">
                        <%= pagination.total %>
                    </dd>
                </div>
            </div>
            
            <div class="card-elevated">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-secondary truncate">
                        <i class="fas fa-check-circle mr-1" aria-hidden="true"></i>
                        Success Rate
                    </dt>
                    <dd class="mt-1 text-3xl font-semibold text-ruxchai-green">
                        <% 
                        const successCount = logs.filter(log => log.response_status >= 200 && log.response_status < 300).length;
                        const successRate = logs.length > 0 ? ((successCount / logs.length) * 100).toFixed(1) : 0;
                        %>
                        <%= successRate %>%
                    </dd>
                </div>
            </div>
            
            <div class="card-elevated">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-secondary truncate">
                        <i class="fas fa-clock mr-1" aria-hidden="true"></i>
                        Avg Response Time
                    </dt>
                    <dd class="mt-1 text-3xl font-semibold text-primary">
                        <% 
                        const avgTime = logs.length > 0 
                            ? Math.round(logs.reduce((sum, log) => sum + log.response_time_ms, 0) / logs.length) 
                            : 0;
                        %>
                        <%= avgTime %>ms
                    </dd>
                </div>
            </div>
            
            <div class="card-elevated">
                <div class="px-4 py-5 sm:p-6">
                    <dt class="text-sm font-medium text-secondary truncate">
                        <i class="fas fa-exclamation-triangle mr-1" aria-hidden="true"></i>
                        Error Count
                    </dt>
                    <dd class="mt-1 text-3xl font-semibold text-red-600">
                        <%= logs.filter(log => log.response_status >= 400).length %>
                    </dd>
                </div>
            </div>
        </div>

        <!-- Logs Table -->
        <div class="table-container">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                Timestamp
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                Method
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                Endpoint
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                Status
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                Response Time
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                IP Address
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">
                                User Agent
                            </th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">Details</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <% if (logs && logs.length > 0) { %>
                            <% logs.forEach(function(log) { %>
                                <tr class="table-row">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">
                                        <%= new Date(log.created_date).toLocaleString() %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="
                                            <% if (log.method === 'GET') { %>
                                                badge-primary
                                            <% } else if (log.method === 'POST') { %>
                                                badge-success
                                            <% } else if (log.method === 'PUT' || log.method === 'PATCH') { %>
                                                badge-warning
                                            <% } else if (log.method === 'DELETE') { %>
                                                status-badge text-white
                                            <% } else { %>
                                                badge-secondary
                                            <% } %>
                                        " <% if (log.method === 'DELETE') { %>style="background-color: var(--color-danger); border-color: var(--color-danger);"<% } %>>
                                            <%= log.method %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-primary">
                                        <div class="max-w-xs truncate" title="<%= log.endpoint %>">
                                            <%= log.endpoint %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="
                                            <% if (log.response_status >= 200 && log.response_status < 300) { %>
                                                badge-success
                                            <% } else if (log.response_status >= 400 && log.response_status < 500) { %>
                                                badge-warning
                                            <% } else if (log.response_status >= 500) { %>
                                                status-badge text-white
                                            <% } else { %>
                                                badge-secondary
                                            <% } %>
                                        " <% if (log.response_status >= 500) { %>style="background-color: var(--color-danger); border-color: var(--color-danger);"<% } %>>
                                            <%= log.response_status %>
                                        </span>
                                        <% if (log.error_message) { %>
                                            <i class="fas fa-exclamation-triangle text-red-500 ml-1" title="<%= log.error_message %>"></i>
                                        <% } %>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">
                                        <span class="<%= log.response_time_ms > 1000 ? 'text-red-600 font-medium' : '' %>">
                                            <%= log.response_time_ms %>ms
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary">
                                        <%= log.ip_address || '-' %>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-secondary">
                                        <div class="max-w-xs truncate" title="<%= log.user_agent %>">
                                            <%= log.user_agent || '-' %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="showLogDetails(<%= JSON.stringify({
                                            timestamp: new Date(log.created_date).toLocaleString(),
                                            method: log.method,
                                            endpoint: log.endpoint,
                                            status: log.response_status,
                                            response_time: log.response_time_ms,
                                            ip_address: log.ip_address,
                                            user_agent: log.user_agent,
                                            request_body: log.request_body,
                                            error_message: log.error_message
                                        }) %>)" class="action-btn action-btn-blue" title="View Details">
                                            <i class="fas fa-eye" aria-hidden="true"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-sm text-secondary">
                                    No logs found for the selected filters
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <% if (pagination && pagination.pages > 1) { %>
                <div class="px-4 py-3 border-t border-gray-200 sm:px-6">
                    <%- include('../partials/pagination', { pagination, query }) %>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div id="logDetailsModal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 table-header0 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeLogDetails()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-primary" id="modal-title">
                                Log Details
                            </h3>
                            <div class="mt-4" id="logDetailsContent">
                                <!-- Log details will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-header px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="closeLogDetails()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:table-header focus:outline-none    sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showLogDetails(log) {
            const modal = document.getElementById('logDetailsModal');
            const content = document.getElementById('logDetailsContent');
            
            let html = '<dl class="space-y-2">';
            
            // Basic details
            html += '<div><dt class="text-sm font-medium text-secondary">Timestamp</dt>';
            html += '<dd class="mt-1 text-sm text-primary">' + log.timestamp + '</dd></div>';
            
            html += '<div><dt class="text-sm font-medium text-secondary">Method</dt>';
            html += '<dd class="mt-1 text-sm text-primary">' + log.method + '</dd></div>';
            
            html += '<div><dt class="text-sm font-medium text-secondary">Endpoint</dt>';
            html += '<dd class="mt-1 text-sm text-primary break-all">' + log.endpoint + '</dd></div>';
            
            html += '<div><dt class="text-sm font-medium text-secondary">Status</dt>';
            html += '<dd class="mt-1 text-sm text-primary">' + log.status + '</dd></div>';
            
            html += '<div><dt class="text-sm font-medium text-secondary">Response Time</dt>';
            html += '<dd class="mt-1 text-sm text-primary">' + log.response_time + 'ms</dd></div>';
            
            if (log.ip_address) {
                html += '<div><dt class="text-sm font-medium text-secondary">IP Address</dt>';
                html += '<dd class="mt-1 text-sm text-primary">' + log.ip_address + '</dd></div>';
            }
            
            if (log.user_agent) {
                html += '<div><dt class="text-sm font-medium text-secondary">User Agent</dt>';
                html += '<dd class="mt-1 text-sm text-primary break-all">' + log.user_agent + '</dd></div>';
            }
            
            if (log.request_body) {
                html += '<div><dt class="text-sm font-medium text-secondary">Request Body</dt>';
                html += '<dd class="mt-1 text-sm text-primary"><pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">' + 
                        JSON.stringify(JSON.parse(log.request_body), null, 2) + '</pre></dd></div>';
            }
            
            if (log.error_message) {
                html += '<div><dt class="text-sm font-medium text-secondary">Error Message</dt>';
                html += '<dd class="mt-1 text-sm text-red-600">' + log.error_message + '</dd></div>';
            }
            
            html += '</dl>';
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }
        
        function closeLogDetails() {
            document.getElementById('logDetailsModal').classList.add('hidden');
        }
        
        function exportLogs() {
            const params = new URLSearchParams(window.location.search);
            params.append('export', 'csv');
            window.location.href = window.location.pathname + '?' + params.toString();
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLogDetails();
            }
        });
    </script>
    ` 
}) %>